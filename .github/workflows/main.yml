name: CI/CD POC

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # ---------------- BACKEND ----------------
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm install

    - name: Start / Restart Backend with PM2
      env:
        MONGODB_URL: ${{ secrets.MONGODB_URL }}
        PORT: 5000
      run: |
        cd backend
        pm2 restart poc-backend || pm2 start server.js --name poc-backend

    # ---------------- FRONTEND ----------------
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm install

    - name: Build Frontend
      run: |
        cd frontend
        npm run build

    - name: Serve Frontend with PM2
      run: |
        pm2 restart poc-frontend || pm2 start "npx serve -s frontend/dist -l 3000" --name poc-frontend

    # ---------------- STATUS ----------------
    - name: Deployment Status
      run: echo "ðŸš€ Backend (5000) & Frontend (3000) deployed successfully!"
